# new/create アクションについて

## `new.html.erb` テンプレートファイル について

新規登録画面を提議するテンプレートファイルは`books/new.html.erb`です。

以下のような内容になっています。

```html
<h1>New Book</h1>

<%= render 'form', book: @book %>

<%= link_to 'Back', books_path %>
```

かなりスッキリしているテンプレートになっています。

このファイルが実際に描画される際には、`render`メソッドによって別のテンプレートファイル(_form.html.erb)が呼び出されます。基本的に新規作成画面と編集画面も共通の内容のものを利用できるので、個別に提議するのではなく、まとめて定義してこのように外部化してしまうのが基本となっています。DRY原則ですね。

こういった大本のテンプレート（この場合は、new.html.erb)から呼び出される断片的なテンプレートのことを部分テンプレートと言います。`render`メソッドがその役割を担っています。

部分テンプレートの命名規則としては、`ファイル名の先頭に_が接頭辞として付属している`ことが挙げられます。

また、`render 'form', book: @book`の `book`というキーワード引数に対して`@book`を渡しているのは、`_form.html.erb`の`book`という変数に代入せよ、という意味です。

## 部分テンプレートファイル`_form.html.erb`について

少しばかりこのファイルは長いのですが、一応以下に`Gist`を使って添付します。

[https://gist.github.com/da6b264826676cb3d069dbdd87898d9f:embed#ブログ説明用の\_form.html.erbです。]

[\_form.html.erb](https://gist.github.com/da6b264826676cb3d069dbdd87898d9f)

### フォームの定義 `form_with`メソッド

参考書では`form_for`メソッドと`form_tag`メソッドが掲載されていましたが、 rails5.1以降では`form_with`に統合されたということなので、`for_with`のまとめを以下では行います。

`form_with`メソッドでは、URLベース、スコープ、モデルを指定して`form`タグを生成できるようになりました。

今回は、モデルを指定してformタグを行う場合について、学習しました。

```ruby
form_with(model: hoge) do |form|
  # body #
end
```

hogeは、modelのオブジェクト。 body 部分には、フォームの本体を入力します。

フォームとモデルを関連付けることで、以下のメリットがあります。

- 入力値をモデルのプロパティに割り当てることができる
- 編集、エラー時などにモデルの現在の値をフォームに書き戻すことができる

これらのメリットによってコード量を最小限に抑えることが可能です。

### プロパティに対応した入力要素を設置する

`form_with`メソッドのブロック内部では、様々なメソッドが呼び出されています。以下にbookの`isbn`の値のフォームを例示します。

```ruby
<%= form_with(model: book) do |form| %>
  <%= form.text_field :isbn %>
<% end %>
```

これがBookオブジェクトを編集するフォームで`isbn`プロパティに対応したテキストボックスを表すわけです。これらのビューヘルパーにはまだ種類はありますが、ここで列挙することはしません。ただし、文法として殆どのビューヘルパーのメソッドに対しては、モデルのプロパティ名に対応した名前(をシンボルで)渡すという点を覚えておいてください。

上記のコードによって実際には以下のような`<input>`要素が出力されます。

```html
<input id="book_isbn" type="text" name="book[isbn]">
```

name属性にもbookオブジェクトのisbnプロパティという形式で名前がセットされていることが確認できます。他の他のフォーム要素も同様ですので、最終的にはフォーム全体として、以下のようなハッシュ形式でサーバ側にデータが渡されることにになります。

```ruby
book: {
  "isbn":"hogehoge",
  "title":"piyopiyo",
  "price":9999,
  # 中略
}
```

## アクションメソッド(new/create) について

新規登録画面に関連するのは以下の２つのアクションです。

- new

    入力フォームを表示するのに呼び出されます.

- create

   フォームから[Creat]ボタンがクリックされたときに呼び出されてデータの登録処理が行われる.

### new アクション

new アクションでは、フォームから入力された情報を格納するための器を用意することです。これによって、テンプレートファイルの側では、それぞれの項目とモデル上のプロパティとを紐付けているわけです。

作成される器は、空のオブジェクトに過ぎませんが、これがなければ`form_with`メソッドで正しくフォームを生成できません。

### paramsメソッド

フォームからの入力値をまとめて取得するには、以下のようにします。

```ruby
parms.require(:book).permit(:isbn, :title, :price, :publish, :published, :dl)
```

`require`メソッドにはモデル名を引数として与えます。`permit`メソッドには取得したいフィールド名をシンボルの配列で与えます。

これによって、フォームで、book[...]と名前付けされた入力値から指定の列名だけを取り出すことができます。上の式による具体的な戻り値は、以下のようなハッシュです。

```ruby
{
  "isbn"=>"978-4-7741-8411-1",
  "title"=>"改訂新版JavaScript本格入門",
  "price"=>"2980",
  "publish"=>"技術評論社",
  "published(1i)"=>"2016",
  "published(2i)"=>"9",
  "published(3i)"=>"30",
  "dl"=>"0"
}
```

まずはフォームからの入力値をまとめて取得する際の定型句として上記は覚えておきましょう。

もちろん、モデル名、列名の部分は、更新対象のテーブル・列に応じて変動します。